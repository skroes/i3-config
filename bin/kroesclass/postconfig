#!/bin/bash
set -e

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -n|--name) INSTANCENAME="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

echo
echo
echo "POSTCONFIG $INSTANCENAME"
echo
echo


set -x

instance=$INSTANCENAME

fqdn="${instance}.westeurope.cloudapp.azure.com"
sleep 2
ip=$(dig +search +short $fqdn)
sleep 2
ssh-keygen -R $fqdn
ssh-keygen -R $ip
ssh-keyscan -H $ip >> ~/.ssh/known_hosts
ssh-keyscan -H $fqdn >> ~/.ssh/known_hosts
sync
sleep 2

HOST=$INSTANCENAME

ssh -v -i kroescontrol  -o "StrictHostKeyChecking no" kroescontrol@${HOST}.westeurope.cloudapp.azure.com mkdir stagingroot
scp -i kroescontrol -r stagingroot/*  -o "StrictHostKeyChecking no" kroescontrol@${HOST}.westeurope.cloudapp.azure.com:stagingroot/

scp -i kroescontrol -r staging/*  -o "StrictHostKeyChecking no" kroescontrol@${HOST}.westeurope.cloudapp.azure.com:

ssh -i kroescontrol  -o "StrictHostKeyChecking no" kroescontrol@${HOST}.westeurope.cloudapp.azure.com << EOF
sudo su -
echo "SuperSecret" | passwd --stdin kroescontrol
sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
systemctl restart sshd
systemctl restart firewalld
systemctl enable firewalld

# initial

# cockpit runs on port 9999
systemctl enable --now cockpit.socket

cp -rv /home/kroescontrol/stagingroot/* /
rm -Rf /home/kroescontrol/stagingroot/

yum update -y
yum install wget curl git httpd -y
#jq

rm /etc/httpd/conf.d/welcome.conf
systemctl enable --now httpd
firewall-cmd --add-service=http --permanent
firewall-cmd --add-service=http

sed -i "s/SHORTHOSTNAME/${HOST}/g" /var/www/html/index.html
sudo restorecon -v /var/www/html/index.html

curl https://download.docker.com/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo
yum makecache

yum install docker-ce -y
#RHEL8 yum install docker-ce --nobest -y

systemctl enable --now docker
sudo usermod -aG docker kroescontrol

#RHEL8 rm /etc/yum.repos.d/docker-ce.repo
#RHEL8 yum makecache

echo DOCKER-COMPOSE
sleep 3

curl -s https://api.github.com/repos/docker/compose/releases/latest \
  | grep browser_download_url \
  | grep docker-compose-Linux-x86_64 \
  | cut -d '"' -f 4 \
  | wget -qi -

sudo mv docker-compose-Linux-x86_64 /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo curl -L https://raw.githubusercontent.com/docker/compose/master/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose
source /etc/bash_completion.d/docker-compose

docker pull redis
docker pull portainer/portainer
docker pull quay.io/vektorlab/ctop:latest
docker pull gcr.io/google-containers/cadvisor
docker pull prom/prometheus
EOF


ssh -i kroescontrol kroescontrol@${HOST}.westeurope.cloudapp.azure.com << EOF
git clone https://github.com/grafana/tutorial-environment.git
cd tutorial-environment
docker-compose up -d
EOF
